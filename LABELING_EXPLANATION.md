# 라벨링 방식 상세 설명

## 전체 프로세스 개요

테이블의 각 셀에 대해 다음 정보를 자동으로 부착합니다:
1. **셀 타입** (cell_type): 헤더인지 데이터인지
2. **시맨틱 레이블** (semantic_label): 셀의 의미 (연도, 금액 등)
3. **병합 정보** (row_span, col_span): 병합된 셀인지

---

## 단계별 상세 과정

### 1단계: 헤더 자동 감지

#### 1-1. 열 헤더 감지 (`_detect_column_headers`)

**알고리즘**:
```python
# 첫 번째 행의 모든 셀을 검사
첫_행 = 테이블[0, :]  # 첫 번째 행 전체

텍스트_개수 = 0
for 각_셀 in 첫_행:
    if 셀이_텍스트이고_숫자가_아니면:
        텍스트_개수 += 1

텍스트_비율 = 텍스트_개수 / 전체_셀_개수

if 텍스트_비율 > 0.5:  # 50% 이상이 텍스트면
    첫_번째_행을_열_헤더로_간주()
```

**구체적 예시**:
```
첫 번째 행: ["연도", "매출액(억원)", "직원수"]
→ "연도" = 텍스트 ✓
→ "매출액(억원)" = 텍스트 ✓  
→ "직원수" = 텍스트 ✓
→ 텍스트 비율 = 3/3 = 100% > 50%
→ ✅ 첫 번째 행을 열 헤더로 인식
```

#### 1-2. 행 헤더 감지 (`_detect_row_headers`)

**알고리즘**:
```python
# 첫 번째 열의 모든 셀을 검사
첫_열 = 테이블[:, 0]  # 첫 번째 열 전체

텍스트_개수 = 0
for 각_셀 in 첫_열:
    if 셀이_텍스트이고_숫자가_아니면:
        텍스트_개수 += 1

텍스트_비율 = 텍스트_개수 / 전체_셀_개수

if 텍스트_비율 > 0.5:
    첫_번째_열을_행_헤더로_간주()
```

**구체적 예시**:
```
첫 번째 열: [2021, 2022, 2023]
→ 2021 = 숫자 ✗
→ 2022 = 숫자 ✗
→ 2023 = 숫자 ✗
→ 텍스트 비율 = 0/3 = 0% < 50%
→ ❌ 첫 번째 열을 행 헤더로 인식하지 않음
```

---

### 2단계: 각 셀에 셀 타입 부착 (`_determine_cell_type`)

**규칙**:
```python
for 각_셀(row, col):
    if row가_열_헤더_행에_있고 col이_행_헤더_열에_있으면:
        cell_type = 'merged'  # 교차점
    elif row가_열_헤더_행에_있으면:
        cell_type = 'column_header'  # 열 헤더
    elif col이_행_헤더_열에_있으면:
        cell_type = 'row_header'  # 행 헤더
    else:
        cell_type = 'data'  # 일반 데이터
```

**구체적 예시** (열 헤더=[0], 행 헤더=[]인 경우):
```
[0, 0]: 2021
  → row=0 (열 헤더 행), col=0 (행 헤더 아님)
  → cell_type = 'column_header'

[0, 1]: 100
  → row=0 (열 헤더 행), col=1 (행 헤더 아님)
  → cell_type = 'column_header'

[1, 0]: 2022
  → row=1 (열 헤더 아님), col=0 (행 헤더 아님)
  → cell_type = 'data'

[1, 1]: 120
  → row=1 (열 헤더 아님), col=1 (행 헤더 아님)
  → cell_type = 'data'
```

---

### 3단계: 병합 셀 감지 (`_detect_merged_cell_span`)

**알고리즘**:
```python
현재_값 = 테이블[row, col]
row_span = 1  # 기본값
col_span = 1  # 기본값

# 아래쪽으로 같은 값이 연속되는지 확인
for i in range(row+1, 마지막_행까지):
    if 테이블[i, col]가_비어있거나 == 현재_값:
        row_span += 1
    else:
        break  # 다른 값 나오면 중단

# 오른쪽으로 같은 값이 연속되는지 확인
for j in range(col+1, 마지막_열까지):
    if 테이블[row, j]가_비어있거나 == 현재_값:
        col_span += 1
    else:
        break  # 다른 값 나오면 중단
```

**구체적 예시**:
```
테이블:
  A  B  C
  A  X  Y
  Z  X  Y

셀 [0, 0] = "A" 검사:
  아래 확인: [1, 0] = "A" ✓ → row_span = 2
  아래 확인: [2, 0] = "Z" ✗ → 중단
  오른쪽 확인: [0, 1] = "B" ✗ → 중단
  → row_span=2, col_span=1 (2행을 병합한 셀)
```

---

### 4단계: 시맨틱 레이블 추출 (`_extract_semantic_label`)

**우선순위 기반 휴리스틱 규칙**:

#### 규칙 1: 연도 감지
```python
if 값이_숫자이고 1900 <= 숫자 <= 2100:
    return '연도'
```

**예시**:
- `2021` → ✅ '연도'
- `1999` → ✅ '연도'
- `1880` → ❌ 연도 아님 (범위 밖)
- `2200` → ❌ 연도 아님 (범위 밖)

#### 규칙 2: 금액 감지
```python
if '원' in 값 or '억' in 값 or '만' in 값:
    return '금액'
```

**예시**:
- `"100만원"` → ✅ '금액'
- `"50억"` → ✅ '금액'
- `"1,000원"` → ✅ '금액'
- `"100"` → ❌ 금액 아님

#### 규칙 3: 비율 감지
```python
if '%' in 값 or 'percent' in 값.lower():
    return '비율'
```

**예시**:
- `"50%"` → ✅ '비율'
- `"percent"` → ✅ '비율'
- `"0.5"` → ❌ 비율 아님

#### 규칙 4: 숫자 데이터
```python
if 값이_숫자:
    if cell_type == 'column_header':
        return '측정값'  # 헤더의 숫자
    else:
        return '데이터값'  # 데이터 셀의 숫자
```

**예시**:
- 헤더의 `"100"` → '측정값'
- 데이터의 `"100"` → '데이터값'

#### 규칙 5: 텍스트 헤더
```python
if cell_type in ['row_header', 'column_header']:
    return 값_자체[:20]  # 헤더 텍스트를 그대로 사용
```

**예시**:
- 헤더의 `"매출액(억원)"` → `"매출액(억원)"` (그대로)
- 헤더의 `"연도"` → `"연도"` (그대로)

---

## 실제 테이블 예시로 전체 과정 설명

### 입력 테이블:
```
        | 연도  | 매출액(억원) | 직원수 |
--------|-------|------------|--------|
 2021   | 100  | 50        |
 2022   | 120  | 55        |
 2023   | 150  | 60        |
```

### 처리 과정:

#### 1. 헤더 감지
- **열 헤더**: ["연도", "매출액(억원)", "직원수"] → row=0이 열 헤더
- **행 헤더**: [2021, 2022, 2023] → 숫자만 있어서 행 헤더로 인식 안 됨

#### 2. 각 셀 처리

**셀 [0, 0]**: "연도" (첫 행, 첫 열)
- 셀 타입: row=0 (열 헤더 행) → `column_header`
- 시맨틱: 텍스트 헤더 → `"연도"`
- 병합: 없음 → row_span=1, col_span=1

**셀 [0, 1]**: "매출액(억원)" (첫 행, 두 번째 열)
- 셀 타입: row=0 (열 헤더 행) → `column_header`
- 시맨틱: 텍스트 헤더 → `"매출액(억원)"`
- 병합: 없음 → row_span=1, col_span=1

**셀 [1, 0]**: 2021 (두 번째 행, 첫 열)
- 셀 타입: row=1 (데이터 행), col=0 (행 헤더 아님) → `data`
- 시맨틱: 2021이 1900-2100 범위 → `"연도"`
- 병합: 없음 → row_span=1, col_span=1

**셀 [1, 1]**: 100 (두 번째 행, 두 번째 열)
- 셀 타입: row=1 (데이터 행), col=1 (행 헤더 아님) → `data`
- 시맨틱: 숫자이고 특수 패턴 없음 → `"데이터값"`
- 병합: 없음 → row_span=1, col_span=1

---

## 최종 결과 구조

각 셀은 다음 정보를 가진 `CellLabel` 객체로 변환됩니다:

```python
CellLabel(
    row=1,
    col=0,
    cell_type='data',
    value=2021,
    row_span=1,
    col_span=1,
    semantic_label='연도'
)
```

이렇게 레이블링된 셀들을 Knowledge Graph로 변환하거나, 구조화된 형식으로 변환하여 RAG에 활용합니다.

---

## 핵심 포인트 요약

1. **완전 자동화**: 사람이 수동으로 라벨을 붙이는 게 아님
2. **규칙 기반 휴리스틱**: 
   - 위치 기반으로 셀 타입 결정
   - 패턴 매칭으로 시맨틱 레이블 추출
3. **단계별 처리**:
   - 헤더 감지 → 셀 타입 결정 → 병합 감지 → 시맨틱 추출
4. **제한사항**:
   - 복잡한 표 구조에서는 헤더 감지가 부정확할 수 있음
   - 시맨틱 레이블은 간단한 패턴만 인식 (LLM 없이)
